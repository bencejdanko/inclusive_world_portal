version: '3.9'

# Development overrides for docker-compose.yml
# This file is automatically loaded with docker-compose.yml
# For production, use: docker-compose -f docker-compose.yml up

services:
  django:
    container_name: inclusive_world_portal_django_dev
    volumes:
      # Mount source code for hot-reloading
      - ./:/app:delegated
      - /app/.venv  # Exclude .venv from mount to preserve container dependencies
      - static_volume:/app/staticfiles
      - media_volume:/app/inclusive_world_portal/media
    environment:
      - DJANGO_SETTINGS_MODULE=config.settings.local
      - DATABASE_URL=postgres://postgres:devpassword123@postgres:5432/inclusive_world_portal
      - POSTGRES_DB=inclusive_world_portal
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=devpassword123
      - REDIS_URL=redis://redis:6379/0
      - DJANGO_DEBUG=True
      - AWS_ACCESS_KEY_ID=minioadmin
      - AWS_SECRET_ACCESS_KEY=minioadmin
      - AWS_STORAGE_BUCKET_NAME=inclusive-world-media
      - AWS_S3_ENDPOINT_URL=http://minio:9000
      - AWS_S3_CUSTOM_DOMAIN=localhost:8080/media
      - AWS_S3_REGION_NAME=us-east-1
      - AWS_S3_USE_SSL=false
    ports:
      - "8000:8000"
    command: >
      sh -c "
        python manage.py migrate --noinput &&
        python manage.py runserver 0.0.0.0:8000
      "
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  celeryworker:
    container_name: inclusive_world_portal_celeryworker_dev
    volumes:
      - ./:/app:delegated
      - /app/.venv
      - media_volume:/app/inclusive_world_portal/media
    environment:
      - DJANGO_SETTINGS_MODULE=config.settings.local
      - DATABASE_URL=postgres://postgres:devpassword123@postgres:5432/inclusive_world_portal
      - REDIS_URL=redis://redis:6379/0
      - AWS_ACCESS_KEY_ID=minioadmin
      - AWS_SECRET_ACCESS_KEY=minioadmin
      - AWS_STORAGE_BUCKET_NAME=inclusive-world-media
      - AWS_S3_ENDPOINT_URL=http://minio:9000
      - AWS_S3_REGION_NAME=us-east-1
      - AWS_S3_USE_SSL=false
    depends_on:
      django:
        condition: service_healthy
    command: celery -A config.celery_app worker -l debug

  celerybeat:
    container_name: inclusive_world_portal_celerybeat_dev
    volumes:
      - ./:/app:delegated
      - /app/.venv
    environment:
      - DJANGO_SETTINGS_MODULE=config.settings.local
      - DATABASE_URL=postgres://postgres:devpassword123@postgres:5432/inclusive_world_portal
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      django:
        condition: service_healthy
    command: celery -A config.celery_app beat -l debug --scheduler django_celery_beat.schedulers:DatabaseScheduler

  # MinIO development overrides
  minio:
    container_name: inclusive_world_portal_minio_dev
    ports:
      - "9000:9000"
      - "9001:9001"  # MinIO Console for development
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin

  # Unified nginx proxy - handles both Django and MinIO routing
  nginx:
    container_name: inclusive_world_portal_nginx_dev
    image: nginx:alpine
    volumes:
      - ./compose/production/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./compose/production/nginx/proxy.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      django:
        condition: service_started
      minio:
        condition: service_healthy
    networks:
      - app_network
    restart: unless-stopped
    ports:
      - "8080:80"
