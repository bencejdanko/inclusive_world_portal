{% load static i18n %}<!DOCTYPE html>
{% get_current_language as LANGUAGE_CODE %}
<html lang="{{ LANGUAGE_CODE }}">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <title>
    {% block title %}Inclusive World Portal{% endblock title %}
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="A management portal for the Inclusive World team." />
  <meta name="author" content="Bence Danko" />
  <link rel="icon" href="{% static 'images/favicons/favicon.ico' %}" />
  
  {% block css %}
    <!-- Latest compiled and minified Bootstrap CSS -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/css/bootstrap.min.css"
          integrity="sha512-SbiR/eusphKoMVVXysTKG/7VseWii+Y3FdHrt0EpKgpToZeemhqHeZeLWLhJutz/2ut2Vw1uQEj2MbRF+TVBUA=="
          crossorigin="anonymous"
          referrerpolicy="no-referrer" />
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <!-- Custom CSS -->
    <link href="{% static 'css/project.css' %}" rel="stylesheet" />
  {% endblock css %}
  
  {% block javascript %}
    <!-- Bootstrap JS -->
    <script defer
            src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/js/bootstrap.min.js"
            integrity="sha512-1/RvZTcCDEUjY/CypiMz+iqqtaoQfAITmNSJY17Myp4Ms5mdxPS5UV7iOfdZoxcGhzFbOm6sntTKJppjvuhg4g=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"></script>
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@2.0.3" defer></script>
    
    <!-- Alpine.js -->
    <script src="https://unpkg.com/alpinejs@3.x.x" defer></script>
    
    <!-- CSRF Token for HTMX -->
    <script>
      document.addEventListener('htmx:configRequest', (e) => {
        const m = document.cookie.match(/csrftoken=([^;]+)/);
        if (m) e.detail.headers['X-CSRFToken'] = decodeURIComponent(m[1]);
      });
    </script>
    
    <!-- Custom JS -->
    <script defer src="{% static 'js/project.js' %}"></script>
  {% endblock javascript %}
</head>

<body class="{% block bodyclass %}{% endblock bodyclass %}">
  {% block body %}
  
  {% if request.user.is_authenticated %}
    <div class="app-wrapper">
      <!-- Sidebar Navigation -->
      <aside class="sidebar" id="sidebar">
        <!-- Sidebar Header with Logo -->
        <div class="sidebar-header">
          <img src="{% static 'images/iw-banner.png' %}" 
               alt="Inclusive World" 
               class="sidebar-logo"
               onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
          <div style="display:none; text-align: center;">
            <h5 style="color: #e84855; font-weight: bold;">Inclusive World</h5>
          </div>
          
            <div class="sidebar-username">@{{ request.user.username }}</div>
            {% if request.user.name %}
              <div class="sidebar-display-name">{{ request.user.name }}</div>
            {% endif %}
          
          {% if user_role_display %}
            <div class="sidebar-role">{{ user_role_display }}</div>
          {% endif %}
        </div>

        <!-- Navigation Items -->
        <nav class="sidebar-nav">
          <div class="nav-section">
            {% for item in nav_items %}
              <div class="nav-item">
                {% if item.registration_status == 'closed_season' %}
                  {# Disabled link for closed season - not clickable but title tooltip works #}
                  <span class="nav-link opacity-50" 
                        title="{{ item.registration_tooltip }}">
                    <i class="{{ item.icon_class }}"></i>
                    <span>{{ item.label }}</span>
                    <i class="bi bi-lock-fill text-secondary ms-auto"></i>
                  </span>
                {% else %}
                  <a href="{{ item.url }}" 
                     class="nav-link {% if request.path == item.url %}active{% endif %} {% if item.registration_status == 'closed_forms' %}opacity-75{% endif %}"
                     {% if item.registration_tooltip %}title="{{ item.registration_tooltip }}"{% endif %}>
                    <i class="{{ item.icon_class }}"></i>
                    <span>{{ item.label }}</span>
                    {% if item.show_notification_badge and unread_notifications_count > 0 %}
                      <span class="badge badge-info rounded-pill ms-auto">{{ unread_notifications_count }}</span>
                    {% elif item.show_completion %}
                      {% if item.is_complete %}
                        <i class="bi bi-check-circle-fill text-success ms-auto" title="Complete"></i>
                      {% else %}
                        <i class="bi bi-exclamation-circle-fill text-warning ms-auto" title="Incomplete"></i>
                      {% endif %}
                    {% elif item.show_status_indicator %}
                      {% if item.registration_status == 'open' %}
                        <i class="bi bi-door-open-fill text-success ms-auto"></i>
                      {% elif item.registration_status == 'closed_forms' %}
                        <i class="bi bi-exclamation-triangle-fill text-warning ms-auto"></i>
                      {% elif item.registration_status == 'closed_season' %}
                        <i class="bi bi-lock-fill text-secondary ms-auto"></i>
                      {% endif %}
                    {% endif %}
                  </a>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        </nav>

        <!-- Logout at Bottom -->
        <div class="sidebar-footer">
          <a href="{% url 'portal:howto_index' %}" class="nav-link">
            <i class="bi bi-book"></i>
            <span>{% translate "How To" %}</span>
          </a>
          <a href="{% url 'account_logout' %}" class="logout-link">
            <i class="bi bi-box-arrow-right"></i>
            <span>{% translate "Logout" %}</span>
          </a>
        </div>
      </aside>

      <!-- Overlay for mobile -->
      <div class="sidebar-overlay" id="sidebarOverlay"></div>

      <!-- Main Content Area -->
      <main class="main-content">
        <!-- Top Banner Alerts -->
        {% if show_form_completion_alert %}
          <div class="top-banner-alerts">
            <div class="top-banner-alert top-banner-alert-warning">
              <div class="top-banner-alert-content">
                <div class="top-banner-alert-text">
                  <div class="">
                    <strong>Registration Requirements Incomplete</strong>
                    <p>You must complete the following before registering for programs:</p>
                  </div>
                  <ul>
                    {% for item in missing_enrollment_items %}
                      <li>{{ item }}</li>
                    {% endfor %}
                  </ul>
                </div>
              </div>
              <div class="top-banner-alert-actions">
                <a href="{% url 'users:detail' user.username %}" class="top-banner-btn top-banner-btn-warning">
                  <i class="bi bi-person-circle"></i>
                  View Profile
                </a>
                <a href="/surveys" class="top-banner-btn top-banner-btn-warning">
                  <i class="bi bi-clipboard-check"></i>
                  View Tasks
                </a>
              </div>
            </div>
          </div>
        {% endif %}

        <!-- Top Bar -->
        <div class="top-bar">
          <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">
            <i class="bi bi-list"></i>
          </button>
          <h1 class="page-title">{% block page_title %}Dashboard{% endblock page_title %}</h1>
        </div>

        <!-- Content Container -->
        <div class="content-container">
          {% if messages %}
            {% for message in messages %}
              <div class="alert alert-dismissible {% if message.tags %}alert-{{ message.tags }}{% endif %}">
                {{ message }}
                <button type="button"
                        class="btn-close"
                        data-bs-dismiss="alert"
                        aria-label="Close"></button>
              </div>
            {% endfor %}
          {% endif %}

          {% block content %}
            <p>Use this document as a way to quick start any new project.</p>
          {% endblock content %}
        </div>
      </main>
    </div>

    <!-- Sidebar Toggle Script -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        function toggleSidebar() {
          sidebar.classList.toggle('show');
          sidebarOverlay.classList.toggle('show');
        }

        if (sidebarToggle) {
          sidebarToggle.addEventListener('click', toggleSidebar);
        }

        if (sidebarOverlay) {
          sidebarOverlay.addEventListener('click', toggleSidebar);
        }

        // Close sidebar on escape key
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && sidebar.classList.contains('show')) {
            toggleSidebar();
          }
        });
      });
    </script>
  {% else %}
    <!-- Non-authenticated users see the regular navbar -->
    <div class="mb-1">
      <nav class="navbar navbar-expand-md navbar-light bg-light">
        <div class="container-fluid">
          <button class="navbar-toggler navbar-toggler-right"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#navbarSupportedContent"
                  aria-controls="navbarSupportedContent"
                  aria-expanded="false"
                  aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <a class="navbar-brand" href="{% url 'home' %}">Inclusive World Portal</a>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
              {% if ACCOUNT_ALLOW_REGISTRATION %}
                <li class="nav-item">
                  <a id="sign-up-link" class="nav-link" href="{% url 'account_signup' %}">{% translate "Sign Up" %}</a>
                </li>
              {% endif %}
              <li class="nav-item">
                <a id="log-in-link" class="nav-link" href="{% url 'account_login' %}">{% translate "Sign In" %}</a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
    </div>
    <div class="container">
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-dismissible {% if message.tags %}alert-{{ message.tags }}{% endif %}">
            {{ message }}
            <button type="button"
                    class="btn-close"
                    data-bs-dismiss="alert"
                    aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
      {% block main %}
        <p>Use this document as a way to quick start any new project.</p>
      {% endblock main %}
    </div>
  {% endif %}
  
  {% endblock body %}
  
  {% block modal %}{% endblock modal %}
  
  {% block inline_javascript %}{% endblock inline_javascript %}
</body>
</html>
