apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: inclusive-world-portal

namePrefix: prod-

resources:
  - ../../base

labels:
  - pairs:
      environment: production

# Production replicas (higher for HA)
replicas:
  - name: django
    count: 3
  - name: celeryworker
    count: 3
  - name: nginx
    count: 3

# ConfigMap patch for production environment
configMapGenerator:
  - name: inclusive-world-config
    behavior: replace
    literals:
      - DJANGO_DEBUG=False
      - DJANGO_ALLOWED_HOSTS=inclusive-world-portal.com,www.inclusive-world-portal.com
      - ENVIRONMENT=production
      - DJANGO_SECURE_SSL_REDIRECT=True
      - DJANGO_SECURE_HSTS_SECONDS=31536000
      - DJANGO_SECURE_HSTS_INCLUDE_SUBDOMAINS=True
      - DJANGO_SECURE_HSTS_PRELOAD=True
      - DJANGO_SESSION_COOKIE_SECURE=True
      - DJANGO_CSRF_COOKIE_SECURE=True
      - DJANGO_SETTINGS_MODULE=config.settings.production
      - POSTGRES_DB=inclusive_world_portal
      - POSTGRES_USER=postgres
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_URL=redis://redis:6379/0
      - AWS_STORAGE_BUCKET_NAME=inclusive-world-media
      - AWS_S3_ENDPOINT_URL=http://minio:9000
      - AWS_S3_REGION_NAME=us-east-1
      - AWS_S3_CUSTOM_DOMAIN=
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - USE_DOCKER=yes
      - IPYTHONDIR=/app/.ipython

# Image tag override (use specific version in production, not 'latest')
images:
  - name: your-registry/inclusive-world-portal
    newTag: v1.0.0  # Update this with actual version

# Additional production resources
resources:
  - namespace-resourcequota.yaml
  - pod-disruption-budget.yaml
  - network-policy.yaml

# Ingress patch with TLS
patchesStrategicMerge:
  - ingress-patch.yaml

# Storage class patches for production
patches:
  # PostgreSQL storage
  - patch: |-
      apiVersion: apps/v1
      kind: StatefulSet
      metadata:
        name: postgres
      spec:
        volumeClaimTemplates:
        - metadata:
            name: postgres-data
          spec:
            storageClassName: fast-ssd  # Change to your storage class
            resources:
              requests:
                storage: 50Gi
    target:
      kind: StatefulSet
      name: postgres
  
  # MinIO storage
  - patch: |-
      apiVersion: apps/v1
      kind: StatefulSet
      metadata:
        name: minio
      spec:
        volumeClaimTemplates:
        - metadata:
            name: minio-data
          spec:
            storageClassName: standard  # Change to your storage class
            resources:
              requests:
                storage: 100Gi
    target:
      kind: StatefulSet
      name: minio
  
  # Django PVC storage classes
  - patch: |-
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: static-files
      spec:
        storageClassName: nfs-client  # Change to your RWX storage class
    target:
      kind: PersistentVolumeClaim
      name: static-files
  
  - patch: |-
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: media-files
      spec:
        storageClassName: nfs-client  # Change to your RWX storage class
    target:
      kind: PersistentVolumeClaim
      name: media-files
